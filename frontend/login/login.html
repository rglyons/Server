<!-- HTML document for the login display -->
<!-- Files included: materialize.min.css, login.css, crypto-js.min.js, materialize.min.js, jquery.js -->
<!-- Upon clicking the facebook and istagram images, the user is redirected to the proper login pages -->
<!-- As of 7/27/17, the login credentials are username: sustainability and password: sustainability. -->
<!-- An ajax post request is used here to communicate with the server.  Also local storage is used to hold the token -->
<!-- The screen layout is handled through a row and column materialize template. -->
<!-- Modified by: Deshawn Rivers -->
<!-- date: 7/27/2017-->

<!DOCTYPE html>
<html>
  <head>
    <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SlugSense Login</title>
    <link rel="stylesheet" href="static/css/materialize.min.css">
    <link rel="stylesheet" href="static/css/login.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <script src="static/js/js.cookie.js"></script>
    <script type="text/javascript">
      /* eslint-disable no-undef */
      // redirect to app page if have token
      var token = Cookies.get('token')
      if (token) {
        console.log('User has login before')
        window.location.href = '/'
      }
      const host = 'http://127.0.0.1:3030'
    </script>
  </head>
  <body>
    <!-- any stuff about columns and rows is magic from ewing -->
    <div class="myContainer">
      <div class="row" style="margin: 0px">
        <div class="col s7 hide-on-med-and-down topLeftSquare border" style="color:white;">
          <div style="margin: 10%;">
            <h1 style="margin-left: 10%;">SlugSense</h1>
            <img src="static/images/forest-login/checkmark.png" height="60px" width="60px" align="center">
            Automated environmental monitoring
            <br>
            <img src="static/images/forest-login/checkmark.png" height="60px" width="60px" align="center">
            Historical data analytics<br>
            <img src="static/images/forest-login/checkmark.png" height="60px" width="60px" align="center">
            Wi-Fiâ„¢ connectivity
            <br>
            <img src="static/images/forest-login/checkmark.png" height="60px" width="60px" align="center">
            Increased crop performance
            <br>
            <img src="static/images/forest-login/checkmark.png" height="60px" width="60px" align="center">
            Reduced environmental footprint
            <br>
            <img src="static/images/forest-login/checkmark.png" height="60px" width="60px" align="center">
            Save water and money
            <br>
            <!-- <div style="margin-left: 25%">
              <a href="https://facebook.com"><img src="static/images/forest-login/facebook.png" height="60px" width="60px" align="center"></a>
              <a href="https://instagram.com"><img src="static/images/forest-login/instagram.png" height="60px" width="60px" align="center"></a>
            </div> -->
          </div>
        </div>
        <form method="post" id="loginForm">
          <div class="col s12 l5 wrapper border">
            <div class="row rightBox">
              <div class="col hide-on-small-only m12" style="margin-top: 140px;"></div>
              <div class="col show-on-small	s12" style="margin-top: 50px;"></div>
              <div class="col hide-on-small-only m3 l2 border"></div>
              <div class="col s12 m6 l8 white border z-depth-3">
                <div class="row border loginBox">
                  <div class="input-field col s12" style="margin-top: 0px;">
                    <input id="username" type="text" class="validate">
                    <label for="username">Username</label>
                  </div>
                  <div class="input-field col s12" style="margin-top: 0px;">
                    <input id="password" type="password" class="validate">
                    <label for="password">Password</label>
                  </div>
                  <!-- a div for error messages to display (jQuery displays errors here) -->
                  <div id="errMess" style="color: gray; text-align: center;"></div>
                  <p style="padding-left: 10px;">
                    <input type="checkbox" id="remember"/>
                    <label for="remember">Remember me for 30 days</label>
                  </p>
                  <div class="row border" style="margin: 3px">
                    <div class="col s12 right-align border">
                      <a class="waves-effect waves-light modal-trigger border" style="font-size: 12px;" href="#sign-up">Sign Up</a>
                    </div>
                  </div>
                  <div class="row border">
                    <div class="col s12 border">
                      <button class="btn waves-effect waves-light">Login</button>
                    </div>
                  </div>
                  <!-- <div style=" font-size: 69%">
                    <p>
                      <a href="#">Forget Username?</a>
                    </p>
                    <p>
                      <a href="#">Forget Password?</a>
                    </p>
                  </div> -->
                  <!-- Modal Trigger -->
                  <p style="text-align: center;">
                    <!-- links to page that's about SlugSense staff! -->
                    <a href="../AboutUs/About.html"><img style="align: center; max-width: 100%; height: auto; width: auto;" src="static/images/logo2.png" alt="About Us"></a>
                  </p>
                </div>
              </div>
              <div class="col hide-on-small-only m3 l2 border"></div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Structure -->
    <div id="sign-up" class="modal modal-fixed-footer myModal" style="max-width: 500px; max-height: 600px;">
      <div class="modal-content">
        <h4>Create Account</h4>
        <div class="row">
          <form class="col s12" method="POST">
            <div class="row" style="margin: 0px">
              <div class="col s2 border">
                <i class="small material-icons border" style="margin-top: 25px;">account_circle</i>
              </div>
              <div class="input-field col s10 border">
                <input id="create_user_name" type="text" class="validate">
                <label for="create_user_name">User Name</label>
              </div>
            </div>
            <div class="row" style="margin: 0px">
              <div class="col s2 border">
                <i class="small material-icons border" style="margin-top: 25px;">email</i>
              </div>
              <div class="input-field col s10 border">
                <input id="create_email" type="email" class="validate">
                <label for="create_email">Email</label>
              </div>
            </div>
            <div class="row" style="margin: 0px">
              <div class="col s2 border">
                <i class="small material-icons border" style="margin-top: 25px;">fingerprint</i>
              </div>
              <div class="input-field col s10 border">
                <input id="create_password" type="password" class="validate">
                <label for="create_password">Password</label>
              </div>
            </div>
            <div id="g-recaptcha" class="g-recaptcha" data-sitekey="6LeYAC4UAAAAAPKYTvape1wnQfo5fYxSGx9s5Rb1"></div>
            <!-- <br/> -->
            <!-- <input type="submit" value="Submit"> -->
          </form>
        </div>
      </div>
      <div class="modal-footer">
        <a href="#!" id="create_account_btn" class="modal-action waves-effect waves-green btn-flat">Sign Up</a>
      </div>
    </div>

    <script src="static/js/jquery.js"></script>
    <script src="static/js/crypto-js.min.js"></script>
    <script src="static/js/materialize.min.js"></script>
    <script src="static/js/index.js"></script>
    <script type="text/javascript">
      /* eslint-disable no-undef */
      var login = function (data) {
        var in10sec = 1 / (24 * 60 * 6)
        if ($('#remember').prop('checked')) {
          Cookies.set('token', data.api_token, {expires: 30})
        } else {
          Cookies.set('token', data.api_token, {expires: in10sec})
        }
        window.location.href = '/'
      }

      var error = function (err) {
        if (err.responseJSON) {
          $('#errMess').text(err.responseJSON.message)
        } else {
          $('#errMess').text('Connection Error.')
        }
      }

      // Create User
      $('#create_account_btn').on('click', function () {
        if ($('#create_email').hasClass('invalid')) {
          alert('Invalid Email')
        } else if (grecaptcha.getResponse() === '') {
          alert('Please verify that you are human')
        } else {
          $.ajax({
            type: 'POST',
            url: host + '/api/users',
            data: {
              username: $('#create_user_name').val(),
              password: CryptoJS.MD5($('#create_password').val()).toString(),
              email: $('#create_email').val(),
              'g-recaptcha-response': grecaptcha.getResponse()
            },
            success: login,
            error: error
          })
        }
      })

      // Register Model
      $('.modal').modal({
        dismissible: true, // Modal can be dismissed by clicking outside of the modal
        opacity: 0.5, // Opacity of modal background
        inDuration: 300, // Transition in duration
        outDuration: 200, // Transition out duration
        startingTop: '4%', // Starting top style attribute
        endingTop: '10%', // Ending top style attribute
        ready: function (modal, trigger) {}, // Callback for Modal open. Modal and trigger parameters available.
        complete: function () {} // Callback for Modal close
      })

      // Register modal jQuery convenience - if someone hits "enter"/submits the login form, this code runs; don't need to click login button manually
      $('#loginForm').submit(function (e) {
        e.preventDefault()

        // need to make sure that fields aren't blank otherwise, spit notification to id="errMess"
        var username = $('#username').val()
        var password = $('#password').val()
        if (!username) {
          $('#errMess').text('Empty Username')
          return
        } else if (!password) {
          $('#errMess').text('Empty Password')
          return
        }

        // API takes POST requests for some reason Peter Alvaro might teach you that RESTful APIs don't use POST
        $.ajax({
          type: 'POST',
          url: host + '/api/users/login',
          data: {
            username: username,
            password: CryptoJS.MD5(password).toString()
          },
          success: login,
          error: error
        })
      })
    </script>
  </body>
</html>
